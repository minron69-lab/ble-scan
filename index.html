<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>BLE Raw æƒææ¸¬è©¦ï¼ˆå«æ”¯æ´åµæ¸¬èˆ‡ fallbackï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    button { margin:4px; padding:8px 12px; }
    pre { background:#111; color:#0f0; padding:10px; max-height:420px; overflow:auto; }
    .hint { color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <h2>Web Bluetooth Raw æƒæ</h2>
  <div>
    <button id="scan">é–‹å§‹æƒæ rawï¼ˆä¸é€£ç·šï¼‰</button>
    <button id="stop" disabled>åœæ­¢æƒæ</button>
    <button id="fallback">æ”¹ç”¨é€£ç·š (requestDevice)</button>
  </div>
  <div class="hint">
    å»ºè­°ç”¨ <b>Android ç‰ˆ Chrome</b>ï¼Œä¸¦åœ¨ <code>chrome://flags</code> å•Ÿç”¨
    <b>Experimental Web Platform features</b>ã€‚<br>
    è‹¥ 10 ç§’å…§æ²’æœ‰ä»»ä½•å»£å‘Šï¼Œæœƒé¡¯ç¤ºæ’æŸ¥å»ºè­°ã€‚
  </div>

  <h3>Log</h3>
  <pre id="log">æº–å‚™ä¸­â€¦</pre>

<script>
const $ = (id)=>document.getElementById(id);
const logEl = $('log');
const btnScan = $('scan'), btnStop = $('stop'), btnFallback = $('fallback');

function log(...a){
  const txt = a.map(x => typeof x==='object' ? JSON.stringify(x,null,2) : String(x)).join(' ');
  logEl.textContent = new Date().toLocaleTimeString()+'  '+txt+'\n'+logEl.textContent;
}
function ab2hex(buf){ return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
function setScanUI(scanning){ btnScan.disabled=scanning; btnStop.disabled=!scanning; }

let watcher=null, advHandler=null, abortCtrl=null, firstSeenTs=null, timeoutId=null;

function cleanup(){
  try{ advHandler && navigator.bluetooth.removeEventListener('advertisementreceived', advHandler);}catch(e){}
  advHandler=null;
  try{ watcher && watcher.stop(); }catch(e){}
  watcher=null;
  try{ abortCtrl && abortCtrl.abort(); }catch(e){}
  abortCtrl=null;
  if (timeoutId){ clearTimeout(timeoutId); timeoutId=null; }
  setScanUI(false);
}

function envCheck(){
  log('ç’°å¢ƒæª¢æŸ¥ï¼šnavigator.bluetooth =', !!navigator.bluetooth);
  log('æ”¯æ´ requestLEScan =', !!(navigator.bluetooth && 'requestLEScan' in navigator.bluetooth));
}

envCheck();

btnScan.onclick = async () => {
  if (!navigator.bluetooth || !('requestLEScan' in navigator.bluetooth)){
    log('âŒ æ­¤ç’°å¢ƒä¸æ”¯æ´ raw æƒæï¼ˆrequestLEScanï¼‰ã€‚è«‹æ”¹ç”¨ Android Chrome æˆ–æŒ‰ä¸‹ã€Œæ”¹ç”¨é€£ç·šã€ã€‚');
    return;
  }
  try{
    abortCtrl = new AbortController();
    watcher = await navigator.bluetooth.requestLEScan({
      acceptAllAdvertisements: true,
      keepRepeatedDevices: true,
      signal: abortCtrl.signal
    });
    setScanUI(true);
    firstSeenTs = null;
    log('âœ… é–‹å§‹æƒæâ€¦ï¼ˆè«‹å°‡è£ç½®é è¿‘ï¼Œä¸¦ç¢ºèªå®ƒåœ¨å»£æ’­ï¼‰');

    // è‹¥ 10 ç§’å…§å®Œå…¨æ²’æ”¶åˆ°ä»»ä½•å»£å‘Šï¼Œçµ¦æç¤º
    timeoutId = setTimeout(() => {
      if (!firstSeenTs){
        log('âš ï¸ 10 ç§’å…§æœªæ”¶åˆ°å»£å‘Šï¼š');
        log('  1) ç¢ºèª Android Chromeï¼Œä¸”å·²å•Ÿç”¨ Experimental Web Platform features');
        log('  2) æª¢æŸ¥ç«™å°/ç³»çµ±æ¬Šé™ï¼šè—ç‰™ã€é™„è¿‘è£ç½®ã€ä½ç½®');
        log('  3) ç”¨ nRF Connect ç¢ºèªè£ç½®çœŸçš„åœ¨å»£æ’­ï¼ˆæœªé€£ç·šç‹€æ…‹ï¼‰');
      }
    }, 10000);

    advHandler = (e)=>{
      if (!firstSeenTs) firstSeenTs = Date.now();
      const name = e.device.name || '(no name)';
      log(`ğŸ”¹ ADV name=${name} id=${e.device.id} RSSI=${e.rssi} tx=${e.txPower}`);
      if (e.uuids?.length) log('  UUIDs:', e.uuids.join(', '));
      if (e.manufacturerData?.size){
        for (const [cid, dv] of e.manufacturerData){
          log(`  MFD companyId=${cid} hex=${ab2hex(dv.buffer)}`);
        }
      } else {
        log('  (ç„¡ manufacturerData)');
      }
      if (e.serviceData?.size){
        for (const [uuid, dv] of e.serviceData){
          log(`  SVC ${uuid} hex=${ab2hex(dv.buffer)}`);
        }
      }
    };
    navigator.bluetooth.addEventListener('advertisementreceived', advHandler);

  } catch(err){
    log('âš ï¸ æƒææœªé–‹å§‹ï¼ˆå¯èƒ½é—œé–‰æˆ–æ‹’çµ•æ¬Šé™ï¼‰ï¼š', err.name || err.message);
    cleanup();
  }
};

btnStop.onclick = () => {
  cleanup();
  log('â¹ï¸ å·²åœæ­¢æƒæ');
};

// Fallbackï¼šä¸æ”¯æ´ raw æ™‚ï¼Œè‡³å°‘è®“ä½ é¸è£ç½®ä¸¦è®€å¹¾å€‹ characteristic
btnFallback.onclick = async () => {
  if (!navigator.bluetooth){
    log('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚');
    return;
  }
  try{
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['generic_access','device_information']
    });
    log('é¸åˆ°è£ç½®ï¼š', device.name || '(no name)', 'id=', device.id);
    device.addEventListener('gattserverdisconnected', () => log('è£ç½®å·²æ–·ç·šï¼š', device.name || device.id));
    const server = await device.gatt.connect();
    log('GATT å·²é€£ç·š');
    try{
      const svc = await server.getPrimaryService('device_information');
      const chars = await svc.getCharacteristics();
      for (const c of chars){
        log('Characteristic:', c.uuid, ' props=', JSON.stringify(c.properties));
        if (c.properties.read){
          const v = await c.readValue();
          log('  è®€åˆ°å€¼(hex):', ab2hex(v.buffer));
        }
      }
    }catch(e){ log('è®€å– device_information å¤±æ•—ï¼š', e.message || e); }
  }catch(e){
    log('æœªé€£ç·šï¼ˆå¯èƒ½å–æ¶ˆ/æ‹’çµ•ï¼‰ï¼š', e.name || e.message || e);
  }
};
</script>
</body>
</html>
