<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>BLE Raw æƒæè¨ºæ–·é </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; padding:20px; }
    button { margin:4px; padding:8px 12px; }
    pre { background:#111; color:#0f0; padding:10px; max-height:420px; overflow:auto; }
    .hint { color:#555; margin-top:8px; }
  </style>
</head>
<body>
  <h2>BLE Raw æƒæè¨ºæ–·</h2>
  <div>
    <button id="env">ç’°å¢ƒæª¢æŸ¥</button>
    <button id="scan">é–‹å§‹æƒæ rawï¼ˆä¸é€£ç·šï¼‰</button>
    <button id="stop" disabled>åœæ­¢æƒæ</button>
    <button id="fallback">æ”¹ç”¨é€£ç·š (requestDevice)</button>
  </div>
  <div class="hint">
    å»ºè­°ç”¨ <b>Android ç‰ˆ Chrome</b>ï¼Œä¸¦åœ¨ <code>chrome://flags</code> å•Ÿç”¨
    <b>Experimental Web Platform features</b>ã€‚<br>
    Android é‚„éœ€åœ¨ç³»çµ±è¨­å®šæˆäºˆ Chrome çš„ã€Œä½ç½®ã€èˆ‡ã€Œé™„è¿‘çš„è£ç½®ã€æ¬Šé™ã€‚
  </div>

  <h3>Log</h3>
  <pre id="log">æº–å‚™ä¸­â€¦</pre>

<script>
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(...a){
  const txt = a.map(x => typeof x==='object' ? JSON.stringify(x,null,2) : String(x)).join(' ');
  logEl.textContent = new Date().toLocaleTimeString()+'  '+txt+'\n'+logEl.textContent;
}
function ab2hex(buf){ return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
function setScanUI(scanning){ $('scan').disabled=scanning; $('stop').disabled=!scanning; }

let watcher=null, advHandler=null, abortCtrl=null, timeoutId=null, firstSeen=false;

async function envCheck(){
  log('UA:', navigator.userAgent);
  log('navigator.bluetooth =', !!navigator.bluetooth);
  if (navigator.bluetooth){
    try{
      const avail = await navigator.bluetooth.getAvailability();
      log('Bluetooth radio available =', avail);
    }catch(e){ log('getAvailability error:', e.message || e); }
    log('requestDevice exists =', !!navigator.bluetooth.requestDevice);
    log('requestLEScan exists =', !!navigator.bluetooth.requestLEScan);
  }
  // ä½ç½®æ¬Šé™ï¼ˆéƒ¨åˆ†å¹³å°æ‰æœ‰ï¼‰
  if (navigator.permissions && navigator.permissions.query){
    try{
      const geo = await navigator.permissions.query({name:'geolocation'});
      log('geolocation permission =', geo.state);
    }catch(e){ log('geolocation permission check failed (not critical).'); }
  }
  log('æç¤º: æ¡Œæ©Ÿ Chrome å¤šåŠç„¡æ³•æ‹¿ raw å»£å‘Šï¼›Android Chrome æ”¯æ´æœ€ä½³ã€‚');
}

function cleanup(){
  try{ advHandler && navigator.bluetooth.removeEventListener('advertisementreceived', advHandler);}catch(e){}
  advHandler=null;
  try{ watcher && watcher.stop(); }catch(e){}
  watcher=null;
  try{ abortCtrl && abortCtrl.abort(); }catch(e){}
  abortCtrl=null;
  if (timeoutId){ clearTimeout(timeoutId); timeoutId=null; }
  setScanUI(false);
}

$('env').onclick = envCheck;

$('scan').onclick = async () => {
  if (!navigator.bluetooth || !('requestLEScan' in navigator.bluetooth)){
    log('âŒ ä¸æ”¯æ´ requestLEScanï¼ˆraw æƒæï¼‰ã€‚è«‹æ”¹ç”¨ Android Chromeï¼Œæˆ–æŒ‰ã€Œæ”¹ç”¨é€£ç·šã€ã€‚');
    return;
  }
  try{
    abortCtrl = new AbortController();
    watcher = await navigator.bluetooth.requestLEScan({
      acceptAllAdvertisements: true,
      keepRepeatedDevices: true,
      signal: abortCtrl.signal
    });
    setScanUI(true);
    firstSeen = false;
    log('âœ… é–‹å§‹æƒæâ€¦è«‹å°‡è£ç½®é è¿‘ä¸”ä¿æŒæœªé€£ç·šç‹€æ…‹ã€‚');

    timeoutId = setTimeout(()=>{
      if (!firstSeen){
        log('âš ï¸ 10 ç§’å…§ç„¡ä»»ä½•å»£å‘Š:');
        log('  â€¢ ç¢ºèª Android Chromeï¼Œchrome://flags é–‹å•Ÿ Experimental Web Platform features å¾Œé‡å•Ÿ');
        log('  â€¢ ç³»çµ±/ç«™å°æ¬Šé™ï¼šè—ç‰™ã€é™„è¿‘è£ç½®ã€ä½ç½® â†’ çš†å…è¨±');
        log('  â€¢ ç”¨ nRF Connect å…ˆç¢ºèªè£ç½®çœŸçš„åœ¨å»£æ’­ï¼ˆæœªé€£ç·šæ™‚ï¼‰');
      }
    }, 10000);

    advHandler = (e)=>{
      if (!firstSeen) firstSeen = true;
      const name = e.device.name || '(no name)';
      log(`ğŸ”¹ ADV name=${name} id=${e.device.id} RSSI=${e.rssi} tx=${e.txPower}`);
      if (e.uuids?.length) log('  UUIDs:', e.uuids.join(', '));
      if (e.manufacturerData?.size){
        for (const [cid, dv] of e.manufacturerData){
          log(`  MFD companyId=${cid} hex=${ab2hex(dv.buffer)}`);
        }
      } else {
        log('  (ç„¡ manufacturerData)');
      }
      if (e.serviceData?.size){
        for (const [uuid, dv] of e.serviceData){
          log(`  SVC ${uuid} hex=${ab2hex(dv.buffer)}`);
        }
      }
    };
    navigator.bluetooth.addEventListener('advertisementreceived', advHandler);

  }catch(err){
    log('âš ï¸ æƒææœªé–‹å§‹ï¼ˆå¯èƒ½å–æ¶ˆ/æ‹’çµ•ï¼‰ï¼š', err.name || err.message);
    cleanup();
  }
};

$('stop').onclick = ()=>{ cleanup(); log('â¹ï¸ å·²åœæ­¢æƒæ'); };

$('fallback').onclick = async () => {
  if (!navigator.bluetooth){ log('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚'); return; }
  try{
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['generic_access','device_information']
    });
    log('é¸åˆ°è£ç½®ï¼š', device.name || '(no name)', 'id=', device.id);
    const server = await device.gatt.connect();
    log('GATT å·²é€£ç·š');
    try{
      const svc = await server.getPrimaryService('device_information');
      const chars = await svc.getCharacteristics();
      for (const c of chars){
        log('Characteristic:', c.uuid, ' props=', JSON.stringify(c.properties));
        if (c.properties.read){
          const v = await c.readValue();
          log('  è®€åˆ°å€¼(hex):', ab2hex(v.buffer));
        }
      }
    }catch(e){ log('è®€å– device_information å¤±æ•—ï¼š', e.message || e); }
  }catch(e){
    log('æœªé€£ç·šï¼ˆå¯èƒ½å–æ¶ˆ/æ‹’çµ•ï¼‰ï¼š', e.name || e.message || e);
  }
};

// é é¢é–‹å•Ÿå…ˆåšä¸€æ¬¡ç’°å¢ƒæª¢æŸ¥
envCheck();
</script>
</body>
</html>
