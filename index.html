<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>BLE Raw 掃描診斷頁</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; padding:20px; }
    button { margin:4px; padding:8px 12px; }
    pre { background:#111; color:#0f0; padding:10px; max-height:420px; overflow:auto; }
    .hint { color:#555; margin-top:8px; }
  </style>
</head>
<body>
  <h2>BLE Raw 掃描診斷</h2>
  <div>
    <button id="env">環境檢查</button>
    <button id="scan">開始掃描 raw（不連線）</button>
    <button id="stop" disabled>停止掃描</button>
    <button id="fallback">改用連線 (requestDevice)</button>
  </div>
  <div class="hint">
    建議用 <b>Android 版 Chrome</b>，並在 <code>chrome://flags</code> 啟用
    <b>Experimental Web Platform features</b>。<br>
    Android 還需在系統設定授予 Chrome 的「位置」與「附近的裝置」權限。
  </div>

  <h3>Log</h3>
  <pre id="log">準備中…</pre>

<script>
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(...a){
  const txt = a.map(x => typeof x==='object' ? JSON.stringify(x,null,2) : String(x)).join(' ');
  logEl.textContent = new Date().toLocaleTimeString()+'  '+txt+'\n'+logEl.textContent;
}
function ab2hex(buf){ return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
function setScanUI(scanning){ $('scan').disabled=scanning; $('stop').disabled=!scanning; }

let watcher=null, advHandler=null, abortCtrl=null, timeoutId=null, firstSeen=false;

async function envCheck(){
  log('UA:', navigator.userAgent);
  log('navigator.bluetooth =', !!navigator.bluetooth);
  if (navigator.bluetooth){
    try{
      const avail = await navigator.bluetooth.getAvailability();
      log('Bluetooth radio available =', avail);
    }catch(e){ log('getAvailability error:', e.message || e); }
    log('requestDevice exists =', !!navigator.bluetooth.requestDevice);
    log('requestLEScan exists =', !!navigator.bluetooth.requestLEScan);
  }
  // 位置權限（部分平台才有）
  if (navigator.permissions && navigator.permissions.query){
    try{
      const geo = await navigator.permissions.query({name:'geolocation'});
      log('geolocation permission =', geo.state);
    }catch(e){ log('geolocation permission check failed (not critical).'); }
  }
  log('提示: 桌機 Chrome 多半無法拿 raw 廣告；Android Chrome 支援最佳。');
}

function cleanup(){
  try{ advHandler && navigator.bluetooth.removeEventListener('advertisementreceived', advHandler);}catch(e){}
  advHandler=null;
  try{ watcher && watcher.stop(); }catch(e){}
  watcher=null;
  try{ abortCtrl && abortCtrl.abort(); }catch(e){}
  abortCtrl=null;
  if (timeoutId){ clearTimeout(timeoutId); timeoutId=null; }
  setScanUI(false);
}

$('env').onclick = envCheck;

$('scan').onclick = async () => {
  if (!navigator.bluetooth || !('requestLEScan' in navigator.bluetooth)){
    log('❌ 不支援 requestLEScan（raw 掃描）。請改用 Android Chrome，或按「改用連線」。');
    return;
  }
  try{
    abortCtrl = new AbortController();
    watcher = await navigator.bluetooth.requestLEScan({
      acceptAllAdvertisements: true,
      keepRepeatedDevices: true,
      signal: abortCtrl.signal
    });
    setScanUI(true);
    firstSeen = false;
    log('✅ 開始掃描…請將裝置靠近且保持未連線狀態。');

    timeoutId = setTimeout(()=>{
      if (!firstSeen){
        log('⚠️ 10 秒內無任何廣告:');
        log('  • 確認 Android Chrome，chrome://flags 開啟 Experimental Web Platform features 後重啟');
        log('  • 系統/站台權限：藍牙、附近裝置、位置 → 皆允許');
        log('  • 用 nRF Connect 先確認裝置真的在廣播（未連線時）');
      }
    }, 10000);

    advHandler = (e)=>{
      if (!firstSeen) firstSeen = true;
      const name = e.device.name || '(no name)';
      log(`🔹 ADV name=${name} id=${e.device.id} RSSI=${e.rssi} tx=${e.txPower}`);
      if (e.uuids?.length) log('  UUIDs:', e.uuids.join(', '));
      if (e.manufacturerData?.size){
        for (const [cid, dv] of e.manufacturerData){
          log(`  MFD companyId=${cid} hex=${ab2hex(dv.buffer)}`);
        }
      } else {
        log('  (無 manufacturerData)');
      }
      if (e.serviceData?.size){
        for (const [uuid, dv] of e.serviceData){
          log(`  SVC ${uuid} hex=${ab2hex(dv.buffer)}`);
        }
      }
    };
    navigator.bluetooth.addEventListener('advertisementreceived', advHandler);

  }catch(err){
    log('⚠️ 掃描未開始（可能取消/拒絕）：', err.name || err.message);
    cleanup();
  }
};

$('stop').onclick = ()=>{ cleanup(); log('⏹️ 已停止掃描'); };

$('fallback').onclick = async () => {
  if (!navigator.bluetooth){ log('❌ 此瀏覽器不支援 Web Bluetooth。'); return; }
  try{
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['generic_access','device_information']
    });
    log('選到裝置：', device.name || '(no name)', 'id=', device.id);
    const server = await device.gatt.connect();
    log('GATT 已連線');
    try{
      const svc = await server.getPrimaryService('device_information');
      const chars = await svc.getCharacteristics();
      for (const c of chars){
        log('Characteristic:', c.uuid, ' props=', JSON.stringify(c.properties));
        if (c.properties.read){
          const v = await c.readValue();
          log('  讀到值(hex):', ab2hex(v.buffer));
        }
      }
    }catch(e){ log('讀取 device_information 失敗：', e.message || e); }
  }catch(e){
    log('未連線（可能取消/拒絕）：', e.name || e.message || e);
  }
};

// 頁面開啟先做一次環境檢查
envCheck();
</script>
</body>
</html>
